{% extends "admin/change_list.html" %}
{% load static %}

{% block search %}
<div class="row">
  <div class="col-sm-8">
    {{ block.super }}
  </div>
  <div class="col-sm-4 text-right">
    <button type="button" class="btn-bootstrap" data-target="#recaudacionModal">Grafica</button>
  </div>
</div>
{% endblock %}

{% block content %}
  {{ block.super }}
  <div class="modal" id="recaudacionModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Modal de Recaudaci칩n</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">&times;</button>
        </div>
        <div class="modal-body">
          <canvas id="recaudacionChart" width="400" height="200"></canvas>
        </div>
        <div class="modal-footer">
            <button class="btn-bootstrap" onclick='window.print()'>Imprimir</button>
        </div>
        {% comment %} <div class="modal-footer">
          <button type="button" class="btn-bootstrap" data-dismiss="modal">Cerrar</button>
        </div> {% endcomment %}
      </div>
    </div>
  </div>
{% endblock %}

{% block extrahead %}
  {{ block.super }}
  <link rel="stylesheet" type="text/css" href="{% static 'css/modal.css' %}">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function(){
      var btn = document.querySelector('[data-target="#recaudacionModal"]');
      var modal = document.getElementById("recaudacionModal");
      var recaudacionChart; 

      // Al hacer click se abre el modal y se carga el gr치fico
      btn.addEventListener("click", function(){
        console.log("Bot칩n modal clickeado");
        modal.classList.add("show");
        loadChartData();
      });
      
      // Cerrar modal
      var closeButtons = modal.querySelectorAll('[data-dismiss="modal"]');
      closeButtons.forEach(function(btnClose){
        btnClose.addEventListener("click", function(){
          modal.classList.remove("show");
        });
      });
      
      function loadChartData(){
        var xhr = new XMLHttpRequest();
        xhr.open("GET", "{% url 'recaudacion_modal' %}?data=1");
        xhr.onreadystatechange = function(){
          if(xhr.readyState === XMLHttpRequest.DONE) {
            if (xhr.status === 200) {
              console.log("Respuesta AJAX:", xhr.responseText);
              var response = JSON.parse(xhr.responseText);
              updateChart(response);
            } else {
              console.error("Error al cargar datos. C칩digo:", xhr.status);
            }
          }
        };
        xhr.send();
      }
      
      function updateChart(data){
        var canvas = document.getElementById('recaudacionChart');
        var ctx = canvas.getContext('2d');
        recaudacionChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: data.labels,
            datasets: [{
              label: 'Cantidad de Recaudaciones',
              data: data.counts,
              backgroundColor: 'rgba(54, 162, 235, 0.5)',
              borderColor: 'rgba(54, 162, 235, 1)',
              borderWidth: 1
            }]
          },
          options: {
            scales: {
              y: { beginAtZero: true }
            }
          }
        });
      }
    });
  </script>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
{% endblock %}
